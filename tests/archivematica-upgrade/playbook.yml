---
- hosts: "all"

  pre_tasks:

    - name: "Set default am_version"
      set_fact:
        am_version: "{{ am_version | default('1.18') }}"

    - include_vars: "../../playbooks/archivematica-noble/vars-singlenode-{{ am_version }}.yml"
      tags:
        - "always"

    - name: "Disable unattended upgrades to avoid dpkg lock"
      service:
        name: "unattended-upgrades"
        state: "stopped"
        enabled: "no"
      become: true
      when: ansible_facts.os_family == "Debian"

    - name: "Stop any apt/dpkg/autoupgrade processes"
      shell: |
        pkill -f 'apt|dpkg|unattended-upgrade|cloud-init' || true
      become: true
      changed_when: false
      failed_when: false
      when: ansible_facts.os_family == "Debian"

    - name: "Wait for dpkg locks to be released"
      shell: |
        for lock in /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock; do
          while fuser "$lock" >/dev/null 2>&1; do
            sleep 2
          done
        done
        dpkg --configure -a
        apt-get -y update
      become: true
      changed_when: false
      when: ansible_facts.os_family == "Debian"

    - name: "Install packages for development convenience"
      apt:
        pkg: "{{ item }}"
        state: "latest"
      with_items:
        - "fish"
      become: "yes"

  roles:

    - role: "artefactual.elasticsearch"
      become: "yes"
      tags:
        - "elasticsearch"
      when: "archivematica_src_search_enabled|bool"

    - role: "artefactual.percona"
      become: "yes"
      tags:
        - "percona"

    - role: "artefactual.nginx"
      become: "yes"
      tags:
        - "nginx"

    - role: "artefactual.gearman"
      become: "yes"
      tags:
        - "gearman"

    - role: "artefactual.clamav"
      become: "yes"
      tags:
        - "clamav"

    - role: "artefactual.archivematica-src"
      become: "yes"
      tags:
        - "archivematica-src"

  post_tasks:

    - name: "change home dir perms (to make transfer source visible)"
      become: "no"
      command: "chmod 755 $HOME"
      tags:
        - "homeperms"
