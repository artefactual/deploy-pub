name: "Archivematica Upgrade Test"
on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"
  pull_request:
    paths:
      - "playbooks/archivematica-noble/**"
      - "tests/archivematica-upgrade/**"
      - "!tests/archivematica-upgrade/README.md"
  push:
    branches:
      - "master"
    paths:
      - "playbooks/archivematica-noble/**"
      - "tests/archivematica-upgrade/**"
      - "!tests/archivematica-upgrade/README.md"

jobs:
  test:
    name: "Archivematica upgrade test"
    runs-on: "ubuntu-22.04"
    env:
      python_version: "3.12"
      STATE_FILE: "${{ github.workspace }}/tests/archivematica-upgrade/artifacts/archivematica_vm.env"
    steps:
      - name: "Check out the code"
        uses: "actions/checkout@v4"

      - name: "Cache KVM base images"
        uses: "actions/cache@v4"
        with:
          path: "${{ github.workspace }}/tests/kvm/.cache"
          key: "kvm-image-upgrade-noble"

      - name: "Install KVM and helper tooling"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-utils \
            cloud-image-utils \
            sshpass \
            jq \
            python3-venv

      - name: "Install Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "${{ env.python_version }}"

      - name: "Cache the virtual environment"
        id: "venv-cache"
        uses: "actions/cache@v4"
        with:
          path: |
            tests/archivematica-upgrade/.venv/
          key: "os-${{ runner.os }}-python-${{ env.python_version }}-upgrade-${{ hashFiles('tests/archivematica-upgrade/requirements.txt') }}"

      - name: "Set up the virtual environment"
        if: "steps.venv-cache.outputs.cache-hit == false"
        working-directory: "${{ github.workspace }}/tests/archivematica-upgrade"
        run: |
          python3 -m venv .venv
          .venv/bin/python -m pip install -r requirements.txt

      - name: "Add virtual environment to PATH"
        working-directory: "${{ github.workspace }}/tests/archivematica-upgrade"
        run: |
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: "Start KVM guest and install stable Archivematica"
        working-directory: "${{ github.workspace }}/tests/archivematica-upgrade"
        env:
          SKIP_CLEANUP: "1"
        run: |
          ./run.sh \
            -e "am_version=1.18" \
            -e "archivematica_src_configure_am_site_url=http://localhost" \
            -e "archivematica_src_configure_ss_url=http://localhost:8000" \
            -t "archivematica-src,elasticsearch,percona,gearman,nginx"

      - name: "Get the Archivematica version"
        run: |
          curl \
              --silent \
              --dump-header - \
              --header 'Authorization: ApiKey admin:this_is_the_am_api_key' \
              --header 'Content-Type: application/json' \
              'http://localhost:8000/api/processing-configuration/' | grep X-Archivematica-Version

      - name: "Call an Archivematica API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_am_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8000/api/processing-configuration/' \
              | jq -r '.processing_configurations == ["automated", "default"]' \
          ) == true

      - name: "Call a Storage Service API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_ss_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8001/api/v2/pipeline/' \
              | jq -r '.meta.total_count == 1' \
          ) == true

      - name: "Uninstall Elasticsearch 6.x"
        run: |
          sshpass -p ubuntu ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 ubuntu@127.0.0.1 \
            "sudo apt-get purge -y elasticsearch || sudo yum remove -y elasticsearch || true; sudo rm -rf /etc/elasticsearch /var/lib/elasticsearch /var/log/elasticsearch || true"

      - name: "Upgrade to the QA version of Archivematica"
        working-directory: "${{ github.workspace }}/tests/archivematica-upgrade"
        env:
          ANSIBLE_ROLES_PATH: "${{ github.workspace }}/tests/archivematica-upgrade/roles:${{ github.workspace }}/tests/archivematica-upgrade/.ansible/roles:${HOME}/.ansible/roles"
        run: |
          ansible-galaxy install -f -p roles/ -r ../../playbooks/archivematica-noble/requirements-qa.yml
          ansible-playbook -i inventory.ini \
              -u ubuntu \
              -e "am_version=qa" \
              -e "archivematica_src_configure_am_site_url=http://localhost" \
              -e "archivematica_src_configure_ss_url=http://localhost:8000" \
              -e "elasticsearch_version=8.19.2" \
              -t "elasticsearch,archivematica-src" \
              playbook.yml

      - name: "Get the Archivematica version"
        run: |
          curl \
              --silent \
              --dump-header - \
              --header 'Authorization: ApiKey admin:this_is_the_am_api_key' \
              --header 'Content-Type: application/json' \
              'http://localhost:8000/api/processing-configuration/' | grep X-Archivematica-Version

      - name: "Call an Archivematica API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_am_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8000/api/processing-configuration/' \
              | jq -r '.processing_configurations == ["automated", "default"]' \
          ) == true

      - name: "Call a Storage Service API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_ss_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8001/api/v2/pipeline/' \
              | jq -r '.meta.total_count == 1' \
          ) == true

      - name: "Collect logs on failure"
        if: "${{ failure() }}"
        working-directory: "${{ github.workspace }}"
        run: |
          LOG_DIR="${GITHUB_WORKSPACE}/tests/archivematica-upgrade/logs"
          mkdir -p "${LOG_DIR}"
          if [[ ! -f "${STATE_FILE}" ]]; then
            echo "No VM state file found; skipping log collection."
            exit 0
          fi
          source tests/kvm/lib.sh
          load_vm_state
          remote_ssh sudo journalctl -u archivematica-mcp-client --no-pager > "${LOG_DIR}/archivematica-mcp-client.log" || true
          remote_ssh sudo journalctl -u archivematica-dashboard --no-pager > "${LOG_DIR}/archivematica-dashboard.log" || true
          remote_ssh sudo journalctl -u elasticsearch --no-pager > "${LOG_DIR}/elasticsearch.log" || true
          remote_ssh sudo journalctl -u mysql --no-pager > "${LOG_DIR}/mysql.log" || true
          remote_ssh sudo journalctl -u mysqld --no-pager > "${LOG_DIR}/mysqld.log" || true
          remote_scp -r ubuntu@127.0.0.1:/var/log/ "${LOG_DIR}/guest-var-log" || true

      - name: "Upload logs on failure"
        if: "${{ failure() }}"
        uses: "actions/upload-artifact@v4"
        with:
          name: "logs-upgrade"
          path: "${{ github.workspace }}/tests/archivematica-upgrade/logs"

      - name: "Stop VM"
        if: "always()"
        env:
          STATE_FILE: "${{ env.STATE_FILE }}"
        run: |
          tests/kvm/stop_vm.sh || true
