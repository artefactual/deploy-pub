name: "Archivematica Acceptance Tests"
on:
  workflow_dispatch:
    inputs:
      am_version:
        description: "Archivematica ref (branch, tag or SHA to checkout)"
        default: "qa/1.x"
        required: true
        type: "string"
      ss_version:
        description: "Archivematica Storage Service ref (branch, tag or SHA to checkout)"
        default: "qa/0.x"
        required: true
        type: "string"
      at_version:
        description: "Archivematica Acceptance Test ref (branch, tag or SHA to checkout)"
        default: "qa/1.x"
        required: true
        type: "string"
  schedule:
    - cron: "0 3 * * *"

jobs:
  test:
    name: "${{ matrix.feature }} / ${{ matrix.image.label }}"
    runs-on: "ubuntu-22.04"
    env:
      am_version: "${{ inputs.am_version || 'qa/1.x' }}"
      ss_version: "${{ inputs.ss_version || 'qa/0.x' }}"
      at_version: "${{ inputs.at_version || 'qa/1.x' }}"
      python_version: "3.10"
      STATE_FILE: "${{ github.workspace }}/tests/archivematica-acceptance-tests/artifacts/archivematica_vm.env"
      VM_CPUS: "4"
      VM_MEMORY_MB: "10240"
      SSH_READY_TIMEOUT: "180"
      SSH_CONNECT_TIMEOUT: "180"
      MIRROR_RETRIES: "10"
      DISABLE_IPV6: "1"
      DISABLE_SELINUX: "1"
    strategy:
      fail-fast: false
      matrix:
        image:
          - label: "rocky9"
            url: "https://download.cloudstack.org/templates/cloud-images/rockylinux/Rocky-9-GenericCloud.latest.x86_64.qcow2"
            mirrors: "https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2 https://download.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2"
          - label: "rocky8"
            url: "https://download.cloudstack.org/templates/cloud-images/rockylinux/Rocky-8-GenericCloud.latest.x86_64.qcow2"
            mirrors: "https://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-GenericCloud-Base.latest.x86_64.qcow2 https://download.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-GenericCloud-Base.latest.x86_64.qcow2"
          - label: "noble"
            url: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
          - label: "jammy"
            url: "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img"
        feature:
          - "aip-encryption-mirror"
          - "aip-encryption"
          - "checksum"
          - "create-aip"
          - "description-rights"
          - "extract-package"
          - "ingest-mkv-conformance"
          - "ingest-policy-check"
          - "metadata-xml"
          - "reingest-aip"
          - "transfer-microservices"
          - "transfer-mkv-conformance"
          - "transfer-policy-check"
          - "uuids-for-directories"
          - "validation"
          - "virus"
        browser:
          - "Firefox"

    steps:
      - name: "Check out code"
        uses: "actions/checkout@v4"

      - name: "Cache KVM base images"
        uses: "actions/cache@v4"
        with:
          path: "${{ github.workspace }}/tests/kvm/.cache"
          key: "kvm-image-${{ matrix.image.label }}"

      - name: "Install KVM and helper tooling"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 \
            qemu-utils \
            cloud-image-utils \
            sshpass \
            jq \
            p7zip-full \
            python3-venv

      - name: "Install Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "${{ env.python_version }}"

      - name: "Cache the virtual environment"
        id: "venv-cache"
        uses: "actions/cache@v4"
        with:
          path: |
            tests/archivematica-acceptance-tests/.venv/
          key: "os-${{ runner.os }}-python-${{ env.python_version }}-aaat-hash-${{ hashFiles('tests/archivematica-acceptance-tests/requirements.txt') }}"

      - name: "Set up the virtual environment"
        if: "steps.venv-cache.outputs.cache-hit == false"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          python3 -m venv .venv
          .venv/bin/python -m pip install -r requirements.txt

      - name: "Add virtual environment to PATH"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          echo "$PWD/.venv/bin" >> $GITHUB_PATH

      - name: "Check out AMAUATs code"
        uses: "actions/checkout@v4"
        with:
          repository: "artefactual-labs/archivematica-acceptance-tests"
          ref: "${{ env.at_version }}"
          path: "${{ github.workspace }}/AMAUATs"

      - name: "Set up AMAUATs virtual environment"
        working-directory: "${{ github.workspace }}/AMAUATs"
        run: |
          python3 -m venv .venv
          .venv/bin/python3 -m pip install -r requirements.txt

      - name: "Start KVM guest and provision Archivematica"
        id: "provision"
        continue-on-error: true
        timeout-minutes: 60
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        env:
          IMAGE_URL: "${{ matrix.image.url }}"
          IMAGE_MIRRORS: "${{ matrix.image.mirrors }}"
          SKIP_CLEANUP: "1"
        run: |
          set -eo pipefail
          ./run.sh \
            -e "archivematica_src_am_version=${{ env.am_version }}" \
            -e "archivematica_src_ss_version=${{ env.ss_version }}"
          echo $? > /tmp/provision_exit_code

      - name: "Upload console log (always)"
        if: "always()"
        run: |
          if [[ -f "${STATE_FILE}" ]]; then
            source tests/kvm/lib.sh
            load_vm_state
            if [[ -n "${QEMU_CONSOLE_LOG:-}" && -f "${QEMU_CONSOLE_LOG}" ]]; then
              mkdir -p tests/archivematica-acceptance-tests/logs
              cp "${QEMU_CONSOLE_LOG}" tests/archivematica-acceptance-tests/logs/console.log
            fi
          fi
        shell: bash
      - name: "Upload console log artifact (always)"
        if: "always() && hashFiles('tests/archivematica-acceptance-tests/logs/console.log') != ''"
        uses: "actions/upload-artifact@v4"
        with:
          name: "console-${{ matrix.image.label }}-${{ matrix.feature }}"
          path: "tests/archivematica-acceptance-tests/logs/console.log"

      - name: "Collect ES logs on provision failure"
        if: "failure() || steps.provision.outcome == 'failure'"
        working-directory: "${{ github.workspace }}"
        run: |
          LOG_DIR="${GITHUB_WORKSPACE}/tests/archivematica-acceptance-tests/logs"
          mkdir -p "${LOG_DIR}"
          if [[ -f "${STATE_FILE}" ]]; then
            source tests/kvm/lib.sh
            load_vm_state
            remote_ssh sudo journalctl --no-pager > "${LOG_DIR}/journalctl.log" || true
            remote_ssh sudo journalctl -u elasticsearch --no-pager > "${LOG_DIR}/elasticsearch.log" || true
            remote_ssh sudo systemctl status elasticsearch --no-pager > "${LOG_DIR}/elasticsearch-status.log" || true
          fi
        shell: bash

      - name: "Prepare SSH access for AMAUATs"
        run: |
          mkdir -p "$HOME/.ssh"
          if [[ ! -f "$HOME/.ssh/id_rsa" ]]; then
            ssh-keygen -t rsa -f "$HOME/.ssh/id_rsa" -N ""
          fi
          echo -e "Host localhost\n  Port 2222\n  StrictHostKeyChecking no\n  UserKnownHostsFile /dev/null" > "$HOME/.ssh/config"
          pub_key="$(cat "$HOME/.ssh/id_rsa.pub")"
          sshpass -p ubuntu ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 ubuntu@127.0.0.1 \
            "mkdir -p ~/.ssh && echo '$pub_key' >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys"

      - name: "Call an Archivematica API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_am_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8000/api/processing-configuration/' \
              | jq -r '.processing_configurations == ["automated", "default"]' \
          ) == true

      - name: "Call a Storage Service API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_ss_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8001/api/v2/pipeline/' \
              | jq -r '.meta.total_count == 1' \
          ) == true

      - name: "Run AMAUATs"
        timeout-minutes: 30
        id: "amauat-run"
        working-directory: "${{ github.workspace }}/AMAUATs"
        env:
          HEADLESS: 1
        run: |
          .venv/bin/behave -i ${{ matrix.feature }}.feature \
              -v \
              --no-capture \
              --no-capture-stderr \
              --no-logcapture \
              --no-skipped \
              -D am_version=1.9 \
              -D driver_name=${{ matrix.browser }} \
              -D am_username=admin \
              -D am_password=archivematica \
              -D am_url=http://localhost:8000/ \
              -D am_api_key="this_is_the_am_api_key" \
              -D ss_username=admin \
              -D ss_password=archivematica \
              -D ss_api_key="this_is_the_ss_api_key" \
              -D ss_url=http://localhost:8001/ \
              -D home=ubuntu \
              -D server_user=ubuntu \
              -D transfer_source_path=/home/ubuntu/archivematica-sampledata/TestTransfers/acceptance-tests \
              -D ssh_identity_file=$HOME/.ssh/id_rsa

      - name: "Collect logs on failure"
        if: "${{ (failure() && steps.amauat-run.outcome == 'failure') || (cancelled() && steps.amauat-run.outcome == 'cancelled') }}"
        working-directory: "${{ github.workspace }}"
        run: |
          LOG_DIR="${GITHUB_WORKSPACE}/tests/archivematica-acceptance-tests/logs"
          mkdir -p "${LOG_DIR}"
          if [[ ! -f "${STATE_FILE}" ]]; then
            echo "No VM state file found; skipping log collection."
            exit 0
          fi
          source tests/kvm/lib.sh
          load_vm_state
          if [[ -f "${QEMU_CONSOLE_LOG}" ]]; then
            cp "${QEMU_CONSOLE_LOG}" "${LOG_DIR}/console.log" || true
          fi
          remote_ssh sudo journalctl -u archivematica-mcp-client --no-pager > "${LOG_DIR}/archivematica-mcp-client.log" || true
          remote_ssh sudo journalctl -u archivematica-dashboard --no-pager > "${LOG_DIR}/archivematica-dashboard.log" || true
          remote_ssh sudo journalctl -u elasticsearch --no-pager > "${LOG_DIR}/elasticsearch.log" || true
          remote_ssh sudo journalctl -u mysql --no-pager > "${LOG_DIR}/mysql.log" || true
          remote_ssh sudo journalctl -u mysqld --no-pager > "${LOG_DIR}/mysqld.log" || true
          remote_ssh sudo journalctl -u clamav-daemon --no-pager > "${LOG_DIR}/clamav-daemon.log" || true
          remote_scp -r ubuntu@127.0.0.1:/var/log/ "${LOG_DIR}/guest-var-log" || true

      - name: "Upload logs on failure"
        if: "${{ (failure() && steps.amauat-run.outcome == 'failure') || (cancelled() && steps.amauat-run.outcome == 'cancelled') }}"
        uses: "actions/upload-artifact@v4"
        with:
          name: "logs-${{ matrix.image.label }}-${{ matrix.feature }}"
          path: "${{ github.workspace }}/tests/archivematica-acceptance-tests/logs"

      - name: "Stop VM"
        if: "always()"
        env:
          STATE_FILE: "${{ env.STATE_FILE }}"
        run: |
          tests/kvm/stop_vm.sh || true
