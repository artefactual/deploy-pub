---
- hosts: "all"

  pre_tasks:

    - include_vars: "archivematica-vars.yml"
      tags:
        - "always"

    - name: "Disable unattended upgrades to avoid dpkg lock"
      service:
        name: "unattended-upgrades"
        state: "stopped"
        enabled: "no"
      become: true
      when: ansible_facts.os_family == "Debian"

    - name: "Stop any apt/dpkg/autoupgrade processes"
      shell: |
        pkill -f 'apt|dpkg|unattended-upgrade|cloud-init' || true
      become: true
      changed_when: false
      failed_when: false
      when: ansible_facts.os_family == "Debian"

    - name: "Wait for dpkg locks to be released"
      shell: |
        for lock in /var/lib/dpkg/lock /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock /var/cache/apt/archives/lock; do
          while fuser "$lock" >/dev/null 2>&1; do
            sleep 2
          done
        done
        dpkg --configure -a
        apt-get -y update
      become: true
      changed_when: false
      when: ansible_facts.os_family == "Debian"

    - name: "Change home dir perms (to make transfer source visible)"
      command: "chmod 755 $HOME"
      become: "no"

  roles:

    - role: "artefactual.elasticsearch"
      become: "yes"

    - role: "artefactual.percona"
      become: "yes"

    - role: "artefactual.gearman"
      become: "yes"

    - role: "artefactual.clamav"
      become: "yes"

    - role: "artefactual.nginx"
      become: "yes"

    - role: "artefactual.archivematica-src"
      become: "yes"
      tags:
        - "archivematica-src"

  post_tasks:

    - name: "restart clamav daemons"
      become: "yes"
      service:
        name: "{{ item }}"
        state: restarted
      loop:
        - "clamav-freshclam"
        - "clamav-daemon"
      when: ansible_os_family == "Debian"
      tags: "restart-clamav"

    - name: "Configure Dashboard settings"
      command: >
        mysql --user="{{ archivematica_src_am_db_user }}"
              --password="{{ archivematica_src_am_db_password }}"
              --host="{{ archivematica_src_am_db_host }}"
              "{{ archivematica_src_am_db_name }}"
              --batch --skip-column-names
              --execute="update DashboardSettings set value=\"{{ item.value }}\" where name=\"{{ item.key }}\";"
      with_dict: "{{ custom_archivematica_src_configure_dashboardsettings }}"
      no_log: True
      when:
        - archivematica_src_configure_dashboard|bool
        - custom_archivematica_src_configure_dashboardsettings is defined

    - name: "Configure AtoM DIP Upload in AM host"
      block:
        - name: "Create rsa for user archivematica"
          user:
            name: "archivematica"
            generate_ssh_key: "yes"
            ssh_key_file: ".ssh/id_rsa"

        - name: "Use StrictHostKeyChecking=no ssh option for archivematica user"
          lineinfile:
            create: "yes"
            path: "/var/lib/archivematica/.ssh/config"
            owner: "archivematica"
            group: "archivematica"
            mode: "0600"
            line: "StrictHostKeyChecking no"
      become: true
