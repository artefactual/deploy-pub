name: "Archivematica Acceptance Tests"
on:
  workflow_dispatch:
    inputs:
      am_version:
        description: "Archivematica ref (branch, tag or SHA to checkout)"
        default: "qa/1.x"
        required: true
        type: "string"
      ss_version:
        description: "Archivematica Storage Service ref (branch, tag or SHA to checkout)"
        default: "qa/0.x"
        required: true
        type: "string"
      at_version:
        description: "Archivematica Acceptance Test ref (branch, tag or SHA to checkout)"
        default: "qa/1.x"
        required: true
        type: "string"
  schedule:
    - cron: "0 3 * * *"
jobs:
  test:
    name: "${{ matrix.feature }} / ${{ matrix.docker_image.label }}"
    runs-on: "ubuntu-22.04"
    env:
      am_version: "${{ inputs.am_version || 'qa/1.x' }}"
      ss_version: "${{ inputs.ss_version || 'qa/0.x' }}"
      at_version: "${{ inputs.at_version || 'qa/1.x' }}"
      python_version: "3.10"
      DISABLE_IPV6: "1"
      DISABLE_SELINUX: "1"
      PODMAN_COMPOSE: "env PATH=${GITHUB_WORKSPACE}/.venv-tests/bin:$PATH podman-compose"
    strategy:
      fail-fast: false
      matrix:
        docker_image:
          - label: "rocky9"
            family: "rhel"
            base_image: "docker.io/rockylinux/rockylinux"
            base_tag: "9"
          - label: "rocky8"
            family: "rhel"
            base_image: "docker.io/rockylinux/rockylinux"
            base_tag: "8"
          - label: "noble"
            family: "ubuntu"
            base_image: "docker.io/library/ubuntu"
            base_tag: "24.04"
          - label: "jammy"
            family: "ubuntu"
            base_image: "docker.io/library/ubuntu"
            base_tag: "22.04"
        feature:
          - "aip-encryption-mirror"
          - "aip-encryption"
          - "checksum"
          - "create-aip"
          - "description-rights"
          - "extract-package"
          - "ingest-mkv-conformance"
          - "ingest-policy-check"
          - "metadata-xml"
          - "reingest-aip"
          - "transfer-microservices"
          - "transfer-mkv-conformance"
          - "transfer-policy-check"
          - "uuids-for-directories"
          - "validation"
          - "virus"
        browser:
          - "Firefox"
    steps:
      - name: "Check out code"
        uses: "actions/checkout@v4"
      - name: "Check out AMAUATs code"
        uses: "actions/checkout@v4"
        with:
          repository: "artefactual-labs/archivematica-acceptance-tests"
          ref: "${{ env.at_version }}"
          path: "${{ github.workspace }}/AMAUATs"
      - name: "Disable AppArmor on runner (mysqld hits AppArmor denials on Rocky)"
        # Action stops AppArmor service so containers run unconfined.
        # See https://github.com/cisagov/action-disable-apparmor
        uses: "cisagov/action-disable-apparmor@v1"
      - name: "Install Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "${{ env.python_version }}"
          cache: "pip"
          cache-dependency-path: |
            tests/archivematica-acceptance-tests/requirements.txt
      - name: "Cache the virtual environment"
        id: "venv-cache"
        uses: "actions/cache@v4"
        with:
          path: |
            tests/archivematica-acceptance-tests/.venv/
          key: "os-${{ runner.os }}-python_version-${{ env.python_version }}-hash-${{ hashFiles('tests/archivematica-acceptance-tests/requirements.txt') }}"
      - name: "Set up the virtual environment"
        if: "steps.venv-cache.outputs.cache-hit == false"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          python3 -m venv .venv
          .venv/bin/python -m pip install -r requirements.txt
      - name: "Add virtual environment to PATH"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run:
          echo "$PWD/.venv/bin" >> $GITHUB_PATH
      - name: "Install podman-compose (shared venv)"
        run: |
          python3 -m venv ${GITHUB_WORKSPACE}/.venv-tests
          ${GITHUB_WORKSPACE}/.venv-tests/bin/python -m pip install --upgrade pip
          ${GITHUB_WORKSPACE}/.venv-tests/bin/python -m pip install podman-compose==1.5.0
          echo "${GITHUB_WORKSPACE}/.venv-tests/bin" >> $GITHUB_PATH
      - name: "Pre-pull systemd base image"
        run: |
          sudo podman pull "${{ matrix.docker_image.base_image }}:${{ matrix.docker_image.base_tag }}"
      - name: "Generate an SSH key and copy it next to the Dockerfile"
        run: |
          mkdir $HOME/.ssh
          ssh-keygen -t rsa -f $HOME/.ssh/id_rsa -N ""
          cp $HOME/.ssh/id_rsa.pub ${{ github.workspace }}/tests/archivematica-acceptance-tests/ssh_pub_key
      - name: "Add port to SSH client configuration"
        run: |
          echo -e "Host localhost\n    Port 2222" > $HOME/.ssh/config
      - name: "Start the Compose environment"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        continue-on-error: true
        run: |
          # Ensure Podman uses unconfined AppArmor profile (compat with old Podman keys)
          sudo mkdir -p /etc/containers
          cat <<'EOF' | sudo tee /etc/containers/containers.conf
          [containers]
          apparmor_profile = "unconfined"
          EOF
          mkdir -p $HOME/.config/containers
          cat <<'EOF' > $HOME/.config/containers/containers.conf
          [containers]
          apparmor_profile = "unconfined"
          EOF

          export PODMAN="sudo podman"
          export BASE_IMAGE="${{ matrix.docker_image.base_image }}"
          export BASE_IMAGE_TAG="${{ matrix.docker_image.base_tag }}"
          export PODMAN_RUN_ARGS="--cgroupns=host --systemd=always --security-opt apparmor=unconfined"
          mkdir -p logs/bootstrap
          set -o pipefail
          ${{ env.PODMAN_COMPOSE }} config > logs/bootstrap/podman-compose-config.yml 2>&1 || true
          BUILD_RC=0
          UP_RC=0
          ${{ env.PODMAN_COMPOSE }} build --pull > logs/bootstrap/podman-compose-build.log 2>&1 || BUILD_RC=$?
          ${{ env.PODMAN_COMPOSE }} --podman-run-args="$PODMAN_RUN_ARGS" up --detach --force-recreate > logs/bootstrap/podman-compose-up.log 2>&1 || UP_RC=$?
          ${{ env.PODMAN_COMPOSE }} ps > logs/bootstrap/podman-compose-ps.txt 2>&1 || true
          echo "BUILD_RC=${BUILD_RC}" > logs/bootstrap/podman-compose-exit-codes.txt
          echo "UP_RC=${UP_RC}" >> logs/bootstrap/podman-compose-exit-codes.txt
      - name: "Check containers came up"
        run: |
          mkdir -p logs/bootstrap
          sudo podman ps -a > logs/bootstrap/podman-ps.txt || true
          sudo podman ps -a --format json > logs/bootstrap/podman-ps.json || true
          sudo podman pod ps > logs/bootstrap/podman-pod-ps.txt || true
          sudo podman images > logs/bootstrap/podman-images.txt || true
          sudo podman version > logs/bootstrap/podman-version.txt || true
          sudo podman info > logs/bootstrap/podman-info.txt || true
      - name: "Capture initial podman state"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          mkdir -p logs/bootstrap
          ${{ env.PODMAN_COMPOSE }} ps > logs/bootstrap/compose-ps.txt || true
          ${{ env.PODMAN_COMPOSE }} logs > logs/bootstrap/compose.log || true
          sudo podman ps -a > logs/bootstrap/podman-ps.txt
          sudo podman ps -a --format json > logs/bootstrap/podman-ps.json || true
          CID=$(sudo podman ps -aqf name=archivematica-acceptance-test_archivematica_1)
          if [ -n "$CID" ]; then
            sudo podman inspect "$CID" > logs/bootstrap/archivematica-inspect.json || true
            sudo podman logs "$CID" > logs/bootstrap/archivematica.log || true
          fi
      - name: "Wait for SSH on 2222"
        run: |
          for i in {1..30}; do
            if nc -z localhost 2222; then
              exit 0
            fi
            sleep 5
          done
          echo "SSH on 2222 did not come up" >&2
          exit 1
      - name: "Install Ansible requirements"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          ansible-galaxy install -f -p roles/ -r requirements.yml
      - name: "Install Archivematica"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
          ANSIBLE_REMOTE_PORT: 2222
        run: |
          ansible-playbook -i localhost, playbook.yml \
              -u artefactual \
              -e "archivematica_src_am_version=${{ env.am_version }} archivematica_src_ss_version=${{ env.ss_version }}" \
              -v
      - name: "Disable machine learning in Elasticsearch"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          ${{ env.PODMAN_COMPOSE }} exec --user root archivematica bash -c 'echo "xpack.ml.enabled: false" | tee -a /etc/elasticsearch/elasticsearch.yml'
          ${{ env.PODMAN_COMPOSE }} exec --user root archivematica service elasticsearch restart
          ${{ env.PODMAN_COMPOSE }} exec --user root archivematica service archivematica-dashboard restart
      - name: "Prepare the container for running the AMAUATs"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          ${{ env.PODMAN_COMPOSE }} exec --user root archivematica usermod -a -G archivematica artefactual
          ${{ env.PODMAN_COMPOSE }} exec --user root archivematica ln -s /home/artefactual /home/archivematica
      - name: "Call an Archivematica API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_am_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8000/api/processing-configuration/' \
              | jq -r '.processing_configurations == ["automated", "default"]' \
          ) == true
      - name: "Call a Storage Service API endpoint"
        run: |
          test $( \
              curl \
                  --silent \
                  --header 'Authorization: ApiKey admin:this_is_the_ss_api_key' \
                  --header 'Content-Type: application/json' \
                  'http://localhost:8001/api/v2/pipeline/' \
              | jq -r '.meta.total_count == 1' \
          ) == true
      - name: "Set up AMAUATs"
        working-directory: "${{ github.workspace }}/AMAUATs"
        run: |
          python3 -m venv .venv
          .venv/bin/python3 -m pip install -r requirements.txt
      - name: "Run AMAUATs"
        id: "amauat-run"
        working-directory: "${{ github.workspace }}/AMAUATs"
        env:
          HEADLESS: 1
        run: |
          .venv/bin/behave -i ${{ matrix.feature }}.feature \
              -v \
              --no-capture \
              --no-capture-stderr \
              --no-logcapture \
              --no-skipped \
              -D am_version=1.9 \
              -D driver_name=${{ matrix.browser }} \
              -D am_username=admin \
              -D am_password=archivematica \
              -D am_url=http://localhost:8000/ \
              -D am_api_key="this_is_the_am_api_key" \
              -D ss_username=admin \
              -D ss_password=archivematica \
              -D ss_api_key="this_is_the_ss_api_key" \
              -D ss_url=http://localhost:8001/ \
              -D home=artefactual \
              -D server_user=artefactual \
              -D transfer_source_path=/home/artefactual/archivematica-sampledata/TestTransfers/acceptance-tests \
              -D ssh_identity_file=$HOME/.ssh/id_rsa
      - name: "Save common logs on failure"
        if: "${{ (failure() && steps.amauat-run.outcome == 'failure') || (cancelled() && steps.amauat-run.outcome == 'cancelled') }}"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          CID=$(sudo podman ps -aqf "label=io.podman.compose.service=archivematica" | head -n1)
          CID=${CID:-$(sudo podman ps -aqf "name=archivematica" | head -n1)}
          if [ -z "$CID" ]; then
            echo "archivematica container not found; skipping common logs" >&2
            exit 0
          fi
          sudo podman exec --user root "$CID" mkdir -p /tmp/logs/journalctl || true
          sudo podman exec --user root "$CID" bash -c 'journalctl -u archivematica-mcp-client --no-pager > /tmp/logs/journalctl/archivematica-mcp-client' || true
          sudo podman exec --user root "$CID" bash -c 'journalctl --no-pager > /tmp/logs/journalctl/full' || true
      - name: "Save logs on failure"
        if: "${{ always() && matrix.docker_image.family == 'ubuntu' && (failure() || cancelled()) }}"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          mkdir -p logs
          CID=$(sudo podman ps -aqf "label=io.podman.compose.service=archivematica" | head -n1)
          CID=${CID:-$(sudo podman ps -aqf "name=archivematica" | head -n1)}
          if [ -z "$CID" ]; then
            echo "archivematica container not found; skipping log copy" >&2
            exit 0
          fi
          sudo podman exec --user root "$CID" bash -c 'cp -r /var/log/{archivematica,mysql,elasticsearch,gearman-job-server,clamav,nginx} /tmp/logs' || true
      - name: "Save logs on failure"
        if: "${{ always() && matrix.docker_image.family != 'ubuntu' && (failure() || cancelled()) }}"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          mkdir -p logs
          CID=$(sudo podman ps -aqf "label=io.podman.compose.service=archivematica" | head -n1)
          CID=${CID:-$(sudo podman ps -aqf "name=archivematica" | head -n1)}
          if [ -z "$CID" ]; then
            echo "archivematica container not found; skipping log copy" >&2
            exit 0
          fi
          sudo podman exec --user root "$CID" bash -c 'journalctl -u mysqld --no-pager > /tmp/logs/journalctl/mysql' || true
          sudo podman exec --user root "$CID" bash -c 'journalctl -u clamd@scan --no-pager > /tmp/logs/journalctl/clamd' || true
          sudo podman exec --user root "$CID" bash -c 'cp -r /var/log/{archivematica,mysqld.log,elasticsearch,nginx} /tmp/logs' || true
      - name: "Copy logs from VM"
        if: "${{ always() && (failure() || cancelled()) }}"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          mkdir -p logs
          CID=$(sudo podman ps -aqf "label=io.podman.compose.service=archivematica" | head -n1)
          CID=${CID:-$(sudo podman ps -aqf "name=archivematica" | head -n1)}
          if [ -z "$CID" ]; then
            echo "archivematica container not found; skipping podman cp" >&2
            exit 0
          fi
          sudo podman cp "$CID":/tmp/logs/ . || true
      - name: "Collect podman diagnostics"
        if: "${{ always() && (failure() || cancelled()) }}"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          mkdir -p logs/host
          CID=$(sudo podman ps -aqf "label=io.podman.compose.service=archivematica" | head -n1)
          CID=${CID:-$(sudo podman ps -aqf "name=archivematica" | head -n1)}
          sudo podman ps -a > logs/host/podman-ps.txt || true
          if [ -n "$CID" ]; then
            sudo podman inspect "$CID" > logs/host/archivematica-inspect.json || true
            sudo podman logs "$CID" > logs/host/archivematica.log || true
          else
            echo "archivematica container not found; skipping inspect/logs" >&2
          fi
          sudo podman images > logs/host/podman-images.txt || true
          sudo podman info > logs/host/podman-info.txt || true
          sudo podman version > logs/host/podman-version.txt || true
          sudo journalctl --no-pager > logs/host/journalctl.txt || true
      - name: "Upload logs on failure"
        if: "${{ always() && (failure() || cancelled()) }}"
        uses: "actions/upload-artifact@v4"
        with:
          name: "logs-${{ matrix.docker_image.label }}-${{ matrix.feature }}"
          path: "${{ github.workspace }}/tests/archivematica-acceptance-tests/logs"
          if-no-files-found: "ignore"
      - name: "List collected logs"
        if: "${{ always() }}"
        working-directory: "${{ github.workspace }}/tests/archivematica-acceptance-tests"
        run: |
          find logs -type f -printf "%p (%s bytes)\n" || true
